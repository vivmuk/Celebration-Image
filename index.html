<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>70s Anime Celebration Generator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Permanent+Marker&display=swap');
        
        body {
            font-family: 'Permanent Marker', cursive;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffebcd; /* Cream background */
            color: #8b4513; /* Brown text */
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="none" stroke="%23ff6b6b" stroke-width="0.5" stroke-dasharray="2 4"/></svg>');
        }
        
        h1 {
            color: #ff6347; /* Tomato red */
            text-align: center;
            font-family: 'Bangers', cursive;
            font-size: 3em;
            text-shadow: 3px 3px 0px #ffd700, 5px 5px 0px #ff8c00;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }
        
        .description {
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.2em;
            color: #ff6347;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        input {
            padding: 15px;
            border: 3px solid #ff6347;
            border-radius: 10px;
            font-size: 18px;
            font-family: 'Permanent Marker', cursive;
            background-color: #fff8dc; /* Light yellow */
            color: #8b4513;
        }
        
        button {
            padding: 15px 20px;
            background-color: #ff6347;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
            transition: all 0.3s;
            box-shadow: 0 5px 0 #cd5c5c;
            position: relative;
            top: 0;
        }
        
        button:hover {
            background-color: #ff4500;
        }
        
        button:active {
            top: 5px;
            box-shadow: 0 0 0 #cd5c5c;
        }
        
        button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            box-shadow: none;
            top: 0;
        }
        
        #result {
            margin-top: 40px;
            text-align: center;
        }
        
        img {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 5px solid #ff6347;
        }
        
        .loading {
            color: #ff6347;
            font-style: italic;
            font-size: 1.2em;
        }
        
        .error {
            color: #ff0000;
            font-weight: bold;
            font-size: 1.2em;
            background-color: #ffe4e1;
            padding: 15px;
            border-radius: 10px;
            border: 2px dashed #ff0000;
        }
        
        .progress-container {
            width: 100%;
            background-color: #fff8dc;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 3px solid #ff6347;
            height: 30px;
            position: relative;
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #ff6347;
            transition: width 0.3s;
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
            animation: progress-animation 2s linear infinite;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #8b4513;
            font-weight: bold;
            text-shadow: 1px 1px 0 #fff;
        }
        
        @keyframes progress-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 40px 0;
            }
        }
        
        .anime-border {
            border: 5px solid #ff6347;
            border-radius: 15px;
            padding: 20px;
            background-color: #fff8dc;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .loading-message {
            margin-top: 10px;
            font-size: 1em;
            color: #8b4513;
        }
        
        .image-container {
            margin: 20px auto;
            max-width: 512px;
            text-align: center;
            position: relative;
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 0;
            background-color: rgba(255, 99, 71, 0.8);
            color: white;
            font-family: 'Bangers', cursive;
            font-size: 24px;
            text-align: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        
        .message {
            margin-top: 15px;
            color: #8b4513;
            font-style: italic;
            text-align: center;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #333;
            text-align: left;
            white-space: pre-wrap;
            display: none;
        }
    </style>
</head>
<body>
    <h1>70s Anime Celebration Generator</h1>
    
    <div class="description">
        <p>✨ Generate a groovy 70s anime-style celebration image with your custom greeting! ✨</p>
    </div>
    
    <div class="anime-border">
        <div class="input-container">
            <input type="text" id="celebration" placeholder="Enter celebration (e.g., Happy Birthday, Merry Christmas, Congratulations)" value="">
            <input type="text" id="person" placeholder="Enter name (e.g., Jon, Spanny, Jimmy)" value="">
            <button id="generate">✨ Generate Anime Image ✨</button>
        </div>
        
        <div id="progress-area" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>
            <div class="loading-message" id="loading-message">
                Creating your groovy anime image... This might take up to 2 minutes!
            </div>
        </div>
    </div>
    
    <div id="result"></div>

    <script>
        // Use modern event listener approach
        const generateButton = document.getElementById('generate');
        
        // Add event listener using the modern approach
        generateButton.addEventListener('click', async function() {
            const celebration = document.getElementById('celebration').value.trim();
            const person = document.getElementById('person').value.trim();
            const resultDiv = document.getElementById('result');
            const progressArea = document.getElementById('progress-area');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const loadingMessage = document.getElementById('loading-message');
            
            // Validate inputs
            if (!celebration || !person) {
                resultDiv.innerHTML = '<p class="error">Please fill in both fields!</p>';
                return;
            }
            
            // Disable button and show loading
            generateButton.disabled = true;
            resultDiv.innerHTML = '';
            progressArea.style.display = 'block';
            
            // Set up messages for longer wait times
            const loadingMessages = [
                "Creating your groovy anime image... This might take up to 2 minutes!",
                "Still working on your masterpiece... 70s anime art with high quality takes time!",
                "Almost there! Adding those vintage 70s vibes with extra detail...",
                "Putting the finishing touches on your celebration image... The wait will be worth it!"
            ];
            
            // Simulate progress since we can't get real-time progress from the API
            let progress = 0;
            let messageIndex = 0;
            
            const progressInterval = setInterval(() => {
                // Gradually increase progress - even slower now for 20 steps
                if (progress < 20) {
                    progress += 0.1;
                } else if (progress < 60) {
                    progress += 0.08;
                } else if (progress < 90) {
                    progress += 0.03;
                } else {
                    progress += 0.01;
                }
                
                if (progress > 95) {
                    progress = 95; // Cap at 95% until we get the actual result
                }
                
                // Update progress bar and text
                progressBar.style.width = progress + '%';
                progressText.innerText = Math.round(progress) + '%';
                
                // Update loading message every 25 seconds
                if (Math.floor(progress / 25) > messageIndex && messageIndex < loadingMessages.length - 1) {
                    messageIndex++;
                    loadingMessage.textContent = loadingMessages[messageIndex];
                }
            }, 800); // Even slower updates for longer wait time
            
            try {
                console.log("Calling serverless function...");
                
                // Call our Netlify serverless function
                const response = await fetch('/.netlify/functions/generate-image-background', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        celebration: celebration,
                        person: person
                    })
                });
                
                console.log("Response received:", response.status);
                
                // Add better error handling for JSON parsing
                let data;
                try {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    console.log("Raw response text:", responseText);
                    
                    if (!responseText || responseText.trim() === '') {
                        throw new Error('Empty response received from server');
                    }
                    
                    data = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error("JSON parsing error:", jsonError);
                    throw new Error(`Failed to parse JSON response: ${jsonError.message}`);
                }
                
                // Complete the progress bar
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.innerText = '100%';
                
                console.log("API Response:", data);
                
                if (data.imageUrl) {
                    console.log("Image URL found:", data.imageUrl);
                    
                    // Check if it's a data URL (base64)
                    const isDataUrl = data.imageUrl.startsWith('data:');
                    
                    // Validate the image URL
                    if (!isDataUrl && !data.imageUrl.startsWith('http')) {
                        console.error("Invalid image URL format:", data.imageUrl);
                        throw new Error("Invalid image URL format received from server");
                    }
                    
                    // Display the generated image
                    resultDiv.innerHTML = `
                        <div class="anime-border">
                            <h3 style="color: #ff6347; font-family: 'Bangers', cursive; font-size: 2em; text-align: center; margin-bottom: 20px;">
                                Your "${celebration} ${person}" Celebration Image:
                            </h3>
                            <div class="image-container">
                                <img src="${data.imageUrl}" alt="${celebration} ${person} celebration image" crossorigin="anonymous">
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                ${isDataUrl ? `
                                    <a href="${data.imageUrl}" download="${celebration}_${person}.png" target="_blank"
                                       style="display: inline-block; padding: 10px 20px; background-color: #ff6347; color: white; 
                                              text-decoration: none; border-radius: 10px; font-family: 'Bangers', cursive; 
                                              font-size: 18px; letter-spacing: 1px; box-shadow: 0 3px 0 #cd5c5c;">
                                        ⬇️ DOWNLOAD IMAGE
                                    </a>
                                ` : `
                                    <a href="${data.imageUrl}" target="_blank"
                                       style="display: inline-block; padding: 10px 20px; background-color: #ff6347; color: white; 
                                              text-decoration: none; border-radius: 10px; font-family: 'Bangers', cursive; 
                                              font-size: 18px; letter-spacing: 1px; box-shadow: 0 3px 0 #cd5c5c;">
                                        🔍 VIEW FULL IMAGE
                                    </a>
                                `}
                            </div>
                            ${data.message ? `<p class="message">${data.message}</p>` : ''}
                            <div class="debug-info" style="display: block;">
                                <strong>Debug Info:</strong><br>
                                Response Status: ${response.status}<br>
                                ${data.error ? `Error: ${data.error}<br>` : ''}
                                ${data.message ? `Message: ${data.message}<br>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Display error message
                    resultDiv.innerHTML = `<p class="error">Error: ${data.error || 'Failed to generate image'}</p>`;
                }
            } catch (error) {
                clearInterval(progressInterval);
                console.error('Error:', error);
                
                // Show more detailed error information
                let errorDetails = error.message || 'Something went wrong';
                if (error.stack) {
                    console.error('Error stack:', error.stack);
                }
                
                resultDiv.innerHTML = `
                    <div class="anime-border">
                        <p class="error">Error: ${errorDetails}</p>
                        <div class="debug-info" style="display: block;">
                            <strong>Error Details:</strong><br>
                            ${error.stack ? error.stack.replace(/\n/g, '<br>') : errorDetails}
                        </div>
                    </div>
                `;
            } finally {
                // Re-enable button and hide progress area
                generateButton.disabled = false;
                progressArea.style.display = 'none';
            }
        });
    </script>
</body>
</html> 